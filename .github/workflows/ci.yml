name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  install:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - uses: actions/cache/save@v4
        with:
          path: node_modules
          key: nm-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

  type-check:
    needs: install
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: nm-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
      - run: npm run type-check

  lint:
    needs: install
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: nm-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
      - run: npm run lint

  test:
    needs: install
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: nm-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
      - run: npm run test:coverage
      - name: Check coverage thresholds
        run: |
          node -e "
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
            const targets = {
              'utils/scoring.ts': 80,
              'lib/alignment.ts': 80,
              'lib/koios.ts': 40,
            };
            const norm = (p) => p.replace(/\\\\/g, '/');
            let failed = false;
            for (const [file, minPct] of Object.entries(targets)) {
              const entry = Object.entries(report).find(([k]) => norm(k).endsWith(file));
              if (!entry) { console.log('SKIP: ' + file + ' (not in report)'); continue; }
              const pct = entry[1].lines.pct;
              const ok = pct >= minPct;
              console.log((ok ? 'PASS' : 'FAIL') + ': ' + file + ' lines=' + pct + '% (min=' + minPct + '%)');
              if (!ok) failed = true;
            }
            if (failed) { console.error('Coverage below threshold'); process.exit(1); }
          "

  build:
    needs: [type-check, lint, test]
    runs-on: ubuntu-latest
    env:
      NEXT_PUBLIC_SUPABASE_URL: https://placeholder.supabase.co
      NEXT_PUBLIC_SUPABASE_ANON_KEY: placeholder
      NEXT_PUBLIC_KOIOS_BASE_URL: https://api.koios.rest/api/v1
      NEXT_PUBLIC_APP_URL: https://drepscore.io
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: nm-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
      - run: npm run build

  sentry-release:
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: build
    runs-on: ubuntu-latest
    env:
      SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
      SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
      SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Create Sentry release
        if: env.SENTRY_AUTH_TOKEN != ''
        uses: getsentry/action-release@v3
        with:
          environment: production
          version: ${{ github.sha }}

  notify:
    if: failure()
    needs: [type-check, lint, test, build]
    runs-on: ubuntu-latest
    steps:
      - name: Discord notification
        if: vars.DISCORD_WEBHOOK_URL != ''
        env:
          DISCORD_WEBHOOK_URL: ${{ vars.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" \
            -d "{\"content\": \"❌ CI failed on \`${{ github.ref_name }}\` — ${{ github.event.head_commit.message || github.event.pull_request.title || 'PR check' }}\\n${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}" \
            "$DISCORD_WEBHOOK_URL"
