name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  type-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm run type-check

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm run lint

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm run test:coverage
      - name: Check coverage thresholds
        run: |
          node -e "
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
            const targets = {
              'utils/scoring.ts': 60,
              'lib/alignment.ts': 60,
              'lib/koios.ts': 10,
            };
            const norm = (p) => p.replace(/\\\\/g, '/');
            let failed = false;
            for (const [file, minPct] of Object.entries(targets)) {
              const entry = Object.entries(report).find(([k]) => norm(k).endsWith(file));
              if (!entry) { console.log('SKIP: ' + file + ' (not in report)'); continue; }
              const pct = entry[1].lines.pct;
              const ok = pct >= minPct;
              console.log((ok ? 'PASS' : 'FAIL') + ': ' + file + ' lines=' + pct + '% (min=' + minPct + '%)');
              if (!ok) failed = true;
            }
            if (failed) { console.error('Coverage below threshold'); process.exit(1); }
          "

  build:
    runs-on: ubuntu-latest
    env:
      NEXT_PUBLIC_SUPABASE_URL: https://placeholder.supabase.co
      NEXT_PUBLIC_SUPABASE_ANON_KEY: placeholder
      NEXT_PUBLIC_KOIOS_BASE_URL: https://api.koios.rest/api/v1
      NEXT_PUBLIC_APP_URL: https://drepscore.io
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm run build
